const e=require("fs"),t=require("path"),n=require("crypto"),l=require("safe-regex"),a=require("obj-memory-cache"),o=a.newCache(),r=["meta","link","img","br","hr","input"],i=/(<(?:link)(?:.*?)(?:rel="stylesheet")(?:[^>]+)?>)/gs;let s={},c="",d="";const g=n.randomBytes(16).toString("hex"),u={if:{hasContent:!0,func:function(e,t,n){if(w(t)){e=[e.join(" ")],t=t.split(/({{{?else(?:\s*?[^}]*|)}}}?)/g).map(t=>t.match(/({{{?else(?:\s*?[^}]*|)}}}?)/g)?((t=t.replace(/{{{?else(\s*?[^}]*|)}}}?/g,"$1"))&&""!==t.trim()||(t=!0),void e.push(t)):t).filter(e=>void 0!==e),e.includes(!0)||e.push(!0);for(let n=0;n<e.length;n++)if(!0===e[n]||l(e[n]))return t[n]||!1}function l(e){e=e.split(/([&|])/g);let t=!1;for(let l=0;l<e.length;l++)if(e[l]=e[l].trim(),""!==e[l]){if(t&&"|"===e[l])break;if(!t&&"&"===e[l])break;"&"!==e[l]&&"|"!==e[l]&&(t=$(e[l],n))}return t}}},each:{hasContent:!0,attrs:["as","of","from"],func:function(e,t,n){if(s&&(s.noEach||s.noForEach)||n.noEach||n.noForEach)return;let l=e[0];delete e[0],l=l.includes("&")?l.split("&"):[l];let a="";for(let o=0;o<l.length;o++){let r=j(n,l[o]);r&&N(r,(n,r)=>{e.as||e.of||(a+=t),a+=t.replace(/({{{?)([\w_\-.:\[\]|]*?=|)(?:"?\s*?((?:\w|\$)(?:[^"}]*))"?)(}}}?)/g,(t,a,i,s,c)=>{(s=s.replace(/[.:\[\]]/g,".").replace(/\.\./g,".")).endsWith(".")&&(s=s.substring(0,s.lastIndexOf(".")));let d=s;if(d.includes(".")&&(d=d.substring(0,s.indexOf("."))),!Object.values(e).includes(d))return t;s=s.includes(".")?s.replace(d+".",""):"";let g=!("{{{"===a&&"}}}"===c);function u(e){if(null==e||!["string","number","bolean"].includes(typeof e))return"";let t="";return(e||0===e)&&(e=e.toString())&&""!==e.trim()&&(t=g?A(e):e),i&&""!==i.trim()?"="!==i.trim()?i+'"'+t+'"':d+'="'+t+'"':t}return d===e.as?u(j(n,s)||n):d===e.of?u(r):d===e.from?u(l[o]):t}).replace(/({{{?)(?:#(\w(?:[\w_\-:]+))\s+?(.*?))(}}}?)/g,(t,n,a,i,s)=>(i=i.split(/([ &|=<>])/g).map(t=>{let n=t;return n.includes(".")&&(n=n.substring(0,a.indexOf("."))),n===e.from?"'"+l[o]+"'":n!==e.as?t:(t=t.includes(".")?"."+t.replace(n+".",""):"",l[o]+"."+r+t)}).join(""),"{{#"+a+" "+i+"}}"))})}return a}},import:{hasContent:!1,func:function(n,l,a,o=!1){if(!(s&&s.noImports||a.noImports)&&n&&n[0]){let l=d||s.type||s.extension||"html";l.startsWith(".")&&(l=l.replace(".",""));let r=t.join(c||s.dir||s.path||__dirname,n[0]+"."+l);if(!r.startsWith(t.join(c||s.dir||s.path||__dirname)))return null;let i=p(r);if(!i){if(e.existsSync(r))try{i=e.readFileSync(r)}catch(e){i=void 0}y(r,i,a)}if(i&&!o)return b(v(i),a);if(i)return v(i)}}}};function m(e,t,n=!1){return e&&t&&"string"==typeof e&&""!==e.trim()&&"function"==typeof t&&"boolean"==typeof n?(e=e.toString().trim(),["if","unless","each","import"].includes(e)?null:(u[e]={hasContent:n,func:t},!0)):null}function f(e){return e&&"string"==typeof e&&""!==e.trim()?(r.includes(e)||r.push(e),!0):null}function p(e){return o.get("template_file_cache:"+e)}function y(e,t,n){t&&(t=t.toString()),o.set("template_file_cache:"+e,t,{expire:n.cache||s.cache})}function h(n,l,a){d=n.substr(n.lastIndexOf(".")),c=t.join(n,"..");let o=p(n);if(o){if(s&&"function"==typeof s.onBeforeRender){let e=s.onBeforeRender(Buffer.from(o,"utf8"));e&&"string"==typeof e&&(o=e)}else if(l&&"function"==typeof l.onBeforeRender){let e=l.onBeforeRender(Buffer.from(o,"utf8"));e&&"string"==typeof e&&(o=e)}let e=L(o,l);if(s&&"function"==typeof s.onAfterRender){let t=s.onAfterRender(Buffer.from(e,"utf8"));t&&"string"==typeof t&&(e=t)}else if(l&&"function"==typeof l.onAfterRender){let t=l.onAfterRender(Buffer.from(e,"utf8"));t&&"string"==typeof t&&(e=t)}return a(null,e.toString())}e.readFile(n,(function(e,t){if(e)return a(e);if(y(n,t,l),s&&"function"==typeof s.onBeforeRender){let e=s.onBeforeRender(t);e&&"string"==typeof e&&(t=e)}else if(l&&"function"==typeof l.onBeforeRender){let e=l.onBeforeRender(t);e&&"string"==typeof e&&(t=e)}let o=L(t,l);if(s&&"function"==typeof s.onAfterRender){let e=s.onAfterRender(Buffer.from(o,"utf8"));e&&"string"==typeof e&&(o=e)}else if(l&&"function"==typeof l.onAfterRender){let e=l.onAfterRender(Buffer.from(o,"utf8"));e&&"string"==typeof e&&(o=e)}return a(null,o.toString())}))}function E(e){return(e||0===e)&&""!==e.toString().trim()}function w(e){return!("string"==typeof e&&""===e.trim()||"object"==typeof e&&Object.keys(e).length<=0||Array.isArray(e)&&e.length<=0||!e&&0!==e&&!1!==e)}function L(n,a){if(n=n.toString(),s&&s.raw)return n;if(n.startsWith("\n")||(n="\n\r"+n),n.endsWith("\n")||(n+="\n\r"),n=v(n),a){let e={};N(a,(t,n)=>{"function"!=typeof t&&(["string","number","boolean","object"].includes(typeof t)||Array.isArray(t))&&(e[n]=t)}),a=e}else a={};if(a.$||(a.$={}),a.lazyLoad&&"object"!=typeof a.lazyLoad&&(a.lazyLoad={method:"post",tag:"body",data:!1}),a.lazyLoad){if(a.lazyLoad.data=a.lazyLoad.data||!1,a.lazyLoad.data&&"string"==typeof a.lazyLoad.data)try{a.lazyLoad.data=JSON.parse(a.lazyLoad.data)}catch(e){a.lazyLoad.data=!1}a.lazyLoad.data&&"object"==typeof a.lazyLoad.data?(a.nonce=a.nonce||a.lazyLoad.data.nonce,a.lazyLoad.method=a.lazyLoad.method||a.lazyLoad.data.method||"post",a.lazyLoad.tag=a.lazyLoad.tag||a.lazyLoad.data.tag||"body",a.lazyLoad.scrollElm=a.lazyLoad.scrollElm||a.lazyLoad.data.scrollElm||!1,a.lazyLoad.afterVars=a.lazyLoad.afterVars||a.lazyLoad.data.afterVars||!1):(a.lazyLoad.method=a.lazyLoad.method||"post",a.lazyLoad.tag=a.lazyLoad.tag||"body")}if(s&&(s.template||s.layout)){let l=s.template||s.layout,o=p(l);if(!o){let n=d||s.type||s.extension||"html";n.startsWith(".")&&(n=n.replace(".",""));let r=t.join(c||s.dir||s.path||__dirname,l+"."+n);if(r.startsWith(t.join(c||s.dir||s.path||__dirname))){try{o=e.readFileSync(r).toString()}catch(e){o=void 0}o&&""===o.trim()&&(o=void 0),o&&(o.startsWith("\n")||(o="\n\r"+o),o.endsWith("\n")||(o+="\n\r"),o=v(o)),y(l,o,a)}else y(l,null,a)}n=n.replace(/{{{?body}}}?/g,"").replace(/<\/?(!DOCTYPE|html|head|body)((\s+?[^>]*?)|)>/gis,""),a.lazyLoad&&a.lazyLoad.tag&&(n=n.replace(new RegExp("<\\/?("+a.lazyLoad.tag.toString().replace(/[^\w_-]/g,"")+")((\\s+?[^>]*?)|)>","gsi"),"")),o&&(n=o.replace(/{{{body}}}/g,n).replace(/{{body}}/g,A(n)))}function o(e,t){return e.replace(/{{{?#(no[_-]?html).*?}}}?(.*?){{{?\/(\1).*?}}}?/gis,(e,n,l)=>{if(!l||""===l.trim())return"";let a=A(l);return t&&(a="{{#no-html}}"+a+"{{/no-html}}"),a})}if(n=o(n,!0),s&&s.noImports||a.noImports||(n=n.replace(/({{{)#import (.*?)(}}})/gis,(e,t,n,l)=>n&&""!==n.trim()?(n=n.trim(),u.import?o(u.import.func([n],!1,a,!0).toString()):""):"")),a.lazyLoad&&a.lazyLoad.earlyVars&&N(a.lazyLoad.earlyVars,e=>{if(!e||"string"!=typeof e||""===e.trim())return;e=e.toString();let t=new RegExp('{{{\\s*?"?('+e+')"?\\s*?}}}',"gs");l(t)&&(n=n.replace(t,(e,t)=>{if(!t||""===t.trim())return e;let n=j(a,t);return n&&""!==n.toString().trim()?n:e}))}),n=z(n),a.lazyLoad&&!a.lazyLoad.afterVars&&a.lazyLoad.tag){let e=new RegExp("(<"+a.lazyLoad.tag.toString()+"(?:(?:\\s+?[^>]*?)|)>)(.*?)(<\\/"+a.lazyLoad.tag.toString()+">)","gsi");if(l(e)){if((n=n.split(e)).length>1&&a.lazyLoad.data&&"object"==typeof a.lazyLoad.data&&a.lazyLoad.data.key===g&&a.lazyLoad.data.page>1){let e=Number(a.lazyLoad.data.page);if(n[2]=n[2].split(/{{#lazy[_-]?load}}/gi,e),n[2].length!==a.lazyLoad.data.page)return"";n[2]=n[2][e-1],n[2][e]&&""!==n[2][e].trim()||(n[2]+="<no-more-lazyload-content></no-more-lazyload-content>"),a.lazyLoad.data.contentOnly&&(n=[n[2]])}else if(n.length>1){let e=n[2].split(/{{#lazy[_-]?load}}/gi,2);n[2]=e[0],e[1]&&""!==e[1].trim()||(n[2]+="<no-more-lazyload-content></no-more-lazyload-content>")}else/{{#lazy[_-]?load}}/i.test(n[2])||(n[2]+="<no-more-lazyload-content></no-more-lazyload-content>");(n=n.join("")).includes("</body>")?n=n.replace(/(<\/body>)/gi,S(a.lazyLoad,a.nonce)+"$1"):n+=S(a.lazyLoad,a.nonce)}}if(n=o(n=b(n,a)),a.lazyLoad&&a.lazyLoad.afterVars&&a.lazyLoad.tag){let e=new RegExp("(<"+a.lazyLoad.tag.toString()+"(?:(?:\\s+?[^>]*?)|)>)(.*?)(<\\/"+a.lazyLoad.tag.toString()+">)","gsi");if(l(e)){if((n=n.split(e)).length>1&&a.lazyLoad.data&&"object"==typeof a.lazyLoad.data&&a.lazyLoad.data.key===g&&a.lazyLoad.data.page>1){let e=Number(a.lazyLoad.data.page);if(n[2]=n[2].split(/{{#lazy[_-]?load}}/gi,e),n[2].length!==a.lazyLoad.data.page)return"";n[2]=n[2][e-1],n[2][e]&&""!==n[2][e].trim()||(n[2]+="<no-more-lazyload-content></no-more-lazyload-content>"),a.lazyLoad.data.contentOnly&&(n=[n[2]])}else if(n.length>1){let e=n[2].split(/{{#lazy[_-]?load}}/gi,2);n[2]=e[0],e[1]&&""!==e[1].trim()||(n[2]+="<no-more-lazyload-content></no-more-lazyload-content>")}else/{{#lazy[_-]?load}}/i.test(n[2])||(n[2]+="<no-more-lazyload-content></no-more-lazyload-content>");(n=n.join("")).includes("</body>")?n=n.replace(/(<\/body>)/gi,S(a.lazyLoad,a.nonce)+"$1"):n+=S(a.lazyLoad,a.nonce)}}if(!(s&&s.noMarkdown||a.noMarkdown)){let e=/({{{?#no[_-]?markdown}}}?(?:.*?){{{?\/no[_-]?markdown}}}?|<script(?:(?:\s+?[^>]*?)|)>(?:.*?)<\/script>|<style(?:(?:\s+?[^>]*?)|)>(?:.*?)<\/style>)/gis,t=/{{{?#no[_-]?markdown}}}?(.*?){{{?\/no[_-]?markdown}}}?/gis;n=n.split(e).map(n=>n.match(t)?n.replace(t,"$1"):n.match(e)?n:P(n)).join("")}return a.autoAdInsert&&(n=n.replace(/(<\/body>)/gi,function(e,t){e.origTag=e.tag,e.origScrollElm=e.scrollElement||e.scrollElm,"body"===e.tag||"window"===e.tag||"document"===e.tag?e.tag="'body'":e.tag="'"+e.tag+"'",e.scrollElement&&(e.scrollElm=e.scrollElement),e.scrollElm&&(e.scrollElm=e.scrollElm.toString().replace(/[^\w_\-.#]/g,"").toLowerCase(),"body"===e.scrollElm||"window"===e.scrollElm||"document"===e.scrollElm?e.scrollElm="window":e.scrollElm="'"+e.scrollElm+"'"),e.distance?(e.distance=e.distance.toString().replace(/[^0-9.%]/g,""),e.distance.includes("%")&&(e.distance="'"+e.distance+"'")):e.distance="'120%'",e.topPadding||0===e.topPadding?e.topPadding=e.topPadding.toString().replace(/[^0-9.]/g,""):e.topPadding="1";let n="";if(e.onInsert){let t="";e.content&&(t=` e.detail.insertAd('${e.content}');`),n=`document.addEventListener('onAdInsert', e => {${e.onInsert}${t}});`}else e.content&&(n=`document.addEventListener('onAdInsert', e => {e.detail.insertAd('${e.content}');});`);let l=e.nonce||t||!1;return l=l&&"string"==typeof l&&""!==l.trim()?' nonce="'+l+'"':"",`\n    <script id="auto-ad-insert-script"${l} async defer>\n    ;(function(){\n        \n        ${n}\n        \n        const useUnsafeUrl = ${!!e.unsafeUrl||!1};\n        const loadElement = ${e.tag||"'body'"};\n        const scrollElement = ${e.scrollElm||e.tag||"window"};\n        \n        const useInnerChildren = ${!!e.includeInnerChildren||!1};\n    \n        let adDistance = ${e.distance};\n        let adTopPadding = ${e.topPadding};\n    \n        let origUrl = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n        if(!useUnsafeUrl){origUrl = origUrl.replace(/[^\\w_\\-+/]/g, '-');}\n    \n        let loadAdNumber = 1;\n        let lastAdScrollHeight = 0;\n    \n        if(typeof adDistance === 'string'){\n            if(adDistance.endsWith('%')){\n                adDistance = Number(adDistance.replace(/[^0-9.]/g, ''));\n                adDistance = adDistance*window.innerHeight/100;\n            }else{adDistance = Number(adDistance.replace(/[^0-9.]/g, ''));}\n        }\n        adDistance = Math.round(adDistance*100)/100;\n    \n        let adInsertInfo = {};\n        function insertAd(content){\n        let ad = document.createElement('div');\n        ad.classList = 'ad auto-ad';\n        ad.innerHTML = content;\n        if(lastAdScrollHeight <= 0 && adTopPadding <= 0){\n            adInsertInfo.child.parentNode.insertBefore(ad, adInsertInfo.child);\n        }else if(adInsertInfo.child.nextSibling){\n            adInsertInfo.child.parentNode.insertBefore(ad, adInsertInfo.child.nextSibling);\n        }else{adInsertInfo.child.parentNode.appendChild(ad);}\n        if(ad.scrollHeight > 0){lastAdScrollHeight += ad.scrollHeight;}\n    }\n    \n        (function(){\n            if(typeof window.CustomEvent === "function"){return false;}\n            function CustomEvent(event, params){\n            params = params || {bubbles: false, cancelable: false, detail: null};\n                let evt = document.createEvent('CustomEvent');\n                evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);\n                return evt;\n            }\n            window.CustomEvent = CustomEvent;\n        })();\n    \n        const onAdInsert = new CustomEvent('onAdInsert', {\n            detail: {\n                insertAd: insertAd,\n                getAdNumber: function(){return loadAdNumber;},\n                getLastScrollHeight: function(){return lastAdScrollHeight;},\n                getAdDistance: function(){return adDistance;},\n                getAdTopPadding: function(){return adTopPadding;}\n            }\n        });\n        \n        function loadAd(){\n            document.addEventListener('DOMContentLoaded', function(){\n                const body = document.body || document.getElementsByTagName('body')[0];\n                function loadAd(elm, scrollElm){\n                    let totalScrollHeight = (scrollElm.scrollHeight || body.scrollHeight) - (scrollElm.innerHeight || scrollElm.clientHeight);\n                    let currentScrollHeight = scrollElm.scrollTop || window.scrollY;\n                    if(totalScrollHeight < 0){totalScrollHeight = (scrollElm.innerHeight || scrollElm.clientHeight);}\n                    if(totalScrollHeight > lastAdScrollHeight){\n                        findAdSpot(elm);\n                            function findAdSpot(elm){\n                                let foundElm = false;\n                                let children = elm.children;\n                                for(let i = 0; i < children.length; i++){\n                                    if(children[i].tagName && !children[i].classList.contains('ad')){\n                                        if(useInnerChildren && children[i].hasChildNodes()){\n                                            foundElm = findAdSpot(children[i]);\n                                        }\n                                        if(foundElm){break;}\n                                        let scrollHeight = currentScrollHeight + children[i].getBoundingClientRect().top;\n                                        if(scrollHeight >= lastAdScrollHeight){\n                                            foundElm = true;\n                                            if(scrollHeight >= adTopPadding){\n                                                adInsertInfo = {elm: elm, child: children[i]};\n                                                document.dispatchEvent(onAdInsert);\n                                            }break;\n                                        }\n                                    }\n                                }return foundElm;\n                            }\n                        lastAdScrollHeight += adDistance;\n                        loadAd(elm, scrollElm);\n                    }\n                }\n    \n                if(scrollElement === window){\n                    loadAd(document.getElementsByTagName(loadElement)[0], window);\n                    document.addEventListener('scroll', function(){\n                        loadAd(document.getElementsByTagName(loadElement)[0], window);\n                        let url = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                        if(!useUnsafeUrl){url = url.replace(/[^\\w_\\-+/]/g, '-');}\n                        if(url !== origUrl){origUrl = url; loadAdNumber = 1; lastAdScrollHeight = 0;}\n                    });\n                }else{\n                    let scrollElm = false;\n                    if(scrollElement.startsWith('#')){scrollElm = document.getElementById(scrollElement.replace('#', ''));}\n                        else if(scrollElement.startsWith('.')){scrollElm = document.getElementsByClassName(scrollElement.replace('.', ''))[0];}\n                        else{scrollElm = document.getElementsByTagName(scrollElement)[0];}\n                        loadAd(document.getElementsByTagName(loadElement)[0], scrollElm);\n                        scrollElm.addEventListener('scroll', function(){\n                            loadAd(document.getElementsByTagName(loadElement)[0], scrollElm);\n                            let url = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                            if(!useUnsafeUrl){url = url.replace(/[^\\w_\\-+/]/g, '-');}\n                            if(url !== origUrl){origUrl = url; loadAdNumber = 1; lastAdScrollHeight = 0;}\n                        });\n                    }\n                });\n        }\n        loadAd();\n    })();\n    <\/script>\n    `}(a.autoAdInsert,a.nonce)+"$1")),s&&s.extract&&(n=function(e,t,n=!0){return e=e.toString(),n&&(e=n(e)),N(t,t=>{let n=[],a=!1;if(a=r.includes(t)?new RegExp("(<(?:"+t+")(?:(?:\\s+?[^>]*?)|)>)","gsi"):new RegExp("(<(?:"+t+")(?:(?:\\s+?[^>]*?)|)>(?:.*?)<\\/(?:"+t+")>)","gsi"),!l(a))return;let o=new RegExp("{{-"+t+"}}","gi");l(o)&&("style"===t&&(e=e.split(i).map(e=>e.match(i)?(n.push(e),""):e).join("")),e=(e=e.split(a).map(e=>!e.match(a)||"link"===t&&e.match(i)?e:(n.push(e),"")).join("")).replace(o,n.join("\n")))}),e}(n,s.extract,!1)),s&&s.keepInvalidVars||a.keepInvalidVars||(n=n.replace(/({{{?(?:(?:[^}]+)|)}}}?)/g,"")),(n=v(n)).toString().trim().replace(/(\t|\s\s+)\r?\n+/g,"")}function z(e){return e.replace(/<!--\s+?(?![@!])(.*?)-->/gs,e=>e.includes("license")||e.includes("licence")||e.includes("(c)")||e.includes("copyright")?e:"")}function b(e,t){return function(e,t){let n={...t};return e.toString().replace(/({{{?)((?:[\w_\-:$]+)\s*?=\s*?|\s*?=\s*?|)([^}]+)(}}}?)/g,(e,t,l,a,o)=>{if(a&&""!==a.trim()){let r="",i=!1;if((a=a.trim()).startsWith("-")||a.startsWith("#")||a.startsWith("/"))return e;a.startsWith('"')&&a.endsWith('"')&&(a=a.substring(a.indexOf('"')+1,a.lastIndexOf('"')),i=!0),l&&(l=l.trim().replace(/\s/g,""));let s=j(n,a);return null!=s&&["string","number","bolean"].includes(typeof s)?l.startsWith("$")&&l.includes("=")?(i&&(s='"'+s.toString()+'"'),n.$[l.replace(/[$=]/g,"")]=s,""):("="===l?(r=a.split("|",1)[0]+"=",i=!0):l.includes("=")&&(r=l,i=!0),w(s)?(i&&(r+='"'),r+="{{{"!==t||"}}}"!==o?A(s):v(z(s)),i&&(r+='"'),r):""):e}return e})}(e=function(e,t){let n={...t};return e.toString().replace(/({{{?)([#$])([\w_\-]+)(:[0-9]|)([^}]*)(}}}?)/g,(e,t,l,a,o,r,i)=>{if(a.trim().match(/(no[_-]?markdown|no[_-]?html|lazy[_-]?load)/gi))return e;if(r=r.trim(),"$"===l&&r.startsWith("="))n.$[a]=j(n,r)||void 0;else if("#"===l&&u[a]&&!u[a].hasContent&&"function"==typeof u[a].func){if(r=r.split(" ").map(e=>e.trim()).filter(E),u[a].attrs){let e={};N(u[a].attrs,t=>{let n=r.indexOf(t);n||(n=r.indexOf(t+":")),n&&r[n+1]&&(e[t]=r[n+1],delete r[n],delete r[n+1])});let t=0;N(r,n=>{let l=t++;for(;e[l]&&t<1e3&&(l=t++,!(t>1e3)););n&&!e[l]&&(e[l]=n)}),r=e}let e=u[a].func(r,null,n,!("{{{"===t&&"}}}"===i));return w(e)?"object"==typeof e?(e.options&&(e.opts=e.options),e.opts&&Object.assign(n,e.opts),e.content||e.result||""):e:""}return e})}(e=function e(t,n){let l={...n},a={level:0},o=[];t=t.toString().replace(/({{{?)([#/$])([\w_\-]+)(:[0-9]|)([^}]*)(}}}?)/g,(n,r,i,s,c,d,g,m)=>{if(s.trim().match(/(no[_-]?markdown|no[_-]?html|lazy[_-]?load)/gi))return n;if(d=d.trim(),"$"===i&&d.startsWith("="))l.$[s]=j(l,d)||void 0;else if("#"===i&&a.level<=0)u[s]&&u[s].hasContent&&(a.level=1,a.func=s,a.index=c,a.attrs=d,a.cleanHtml=!("{{{"===r&&"}}}"===g),a.attrTypes=u[s].attrs||!1,a.regexIndex=m,a.strLength=n.length,a.thisStr=n);else if("/"===i&&s===a.func&&c===a.index&&a.level<=1){if("function"==typeof u[s].func){let i=a.attrs.split(" ").map(e=>e.trim()).filter(E);if(a.attrTypes){let e={};N(a.attrTypes,t=>{let n=i.indexOf(t);n||(n=i.indexOf(t+":")),-1!==n&&i[n+1]&&(e[t]=i[n+1],i[n]=void 0,i[n+1]=void 0)});let t=0;N(i,n=>{if(!n)return;let l=t++;for(;e[l]&&t<1e3&&(l=t++,!(t>1e3)););n&&!e[l]&&(e[l]=n)}),i=e}let c=t.substring(a.regexIndex+a.strLength,m),d=u[s].func(i,c,l,a.cleanHtml&&!("{{{"===r&&"}}}"===g)),f=a.thisStr+c+n;a={level:0},w(d)&&("object"==typeof d&&(d.options&&(d.opts=d.options),d.opts&&Object.assign(l,d.opts),o.push([f,e(d.content||d.result||c||"",l)||""])),o.push([f,e(d||"",l)||""]))}}else a.level>0&&("#"===i&&s===a.func?a.level++:"/"===i&&s===a.func&&a.level--);return n});for(let e=0;e<o.length;e++)t=t.replace(o[e][0],o[e][1]);return t}(e,t),t),t)}function $(e,t){function n(n){let l=e.split(n);return l[0]&&(l[0]=j(t,l[0].toString().trim()),l[0]&&l[0].toString().match(/[0-9.]/)&&!isNaN(Number(l[0].toString().replace(/'/g,"")))&&(l[0]=Number(l[0].toString().replace(/'/g,"")))),l[1]&&(l[1]=j(t,l[1].toString().trim()),l[1]&&l[1].toString().match(/[0-9.]/)&&!isNaN(Number(l[1].toString().replace(/'/g,"")))&&(l[1]=Number(l[1].toString().replace(/'/g,"")))),[l[0],l[1]]}if(e.includes("<=")){let e=n("<=");return e[0]<=e[1]}if(e.includes(">=")){let e=n(">=");return e[0]>=e[1]}if(e.includes("<")){let e=n("<");return e[0]<e[1]}if(e.includes(">")){let e=n(">");return e[0]>e[1]}if(e.includes("!=")){let e=n("!=");return e[0]!==e[1]}if(e.includes("=")){let e=n("=");return e[0]===e[1]}return e.startsWith("!")?!j(t,e.replace("!","")):!!j(t,e)}function S(e,t){e.origMethod=e.method,e.origTag=e.tag,e.origScrollElm=e.scrollElement||e.scrollElm,e.method=e.method.toString().replace(/[^\w]/g,"").toUpperCase(),"POST"!==e.method&&"GET"!==e.method&&e.method,e.tag=e.tag.toString().replace(/[^\w_-]/g,"").toLowerCase(),"body"===e.tag||"window"===e.tag||"document"===e.tag?e.tag="window":e.tag="'"+e.tag+"'",e.scrollElement&&(e.scrollElm=e.scrollElement),e.scrollElm&&(e.scrollElm=e.scrollElm.toString().replace(/[^\w_\-.#]/g,"").toLowerCase(),"body"===e.scrollElm||"window"===e.scrollElm||"document"===e.scrollElm?e.scrollElm="window":e.scrollElm="'"+e.scrollElm+"'");let n=e.nonce||t||!1;return n=n&&"string"==typeof n&&""!==n.trim()?' nonce="'+n+'"':"",`\n    <script id="lazy-load-page-script"${n} async defer>\n    ;(function(){\n        let nextPage = 2;\n        let hasMorePages = true;\n        let gettingPage = false;\n        let origUrl = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n        if(${!e.unsafeUrl||!0}){origUrl = origUrl.replace(/[^\\w_\\-+/]/g, '-');}\n        \n        (function(){\n            if(typeof window.CustomEvent === "function"){return false;}\n            function CustomEvent(event, params){\n                params = params || {bubbles: false, cancelable: false, detail: null};\n                let evt = document.createEvent('CustomEvent');\n                evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);\n                return evt;\n            }\n            window.CustomEvent = CustomEvent;\n        })();\n        \n        const onPageLazyLoad = new CustomEvent('onPageLazyLoad', {\n            detail: {\n                getPage: function(){return nextPage-1;}\n            }\n        });\n        \n        document.dispatchEvent(onPageLazyLoad);\n        \n        function loadPageAjax(jQuery){\n            jQuery(document).ready(function(){\n                function getNextPage(elm, scrollElm){\n                    let totalScrollHeight = (scrollElm.prop('scrollHeight') || document.body.scrollHeight) - scrollElm.innerHeight();\n                    let currentScrollHeight = scrollElm.scrollTop();\n                    if(!gettingPage && totalScrollHeight - currentScrollHeight < 200){\n                        gettingPage = true;\n                        let url = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                        if(${!e.unsafeUrl||!0}){url = url.replace(/[^\\w_\\-+/]/g, '-');}\n                        if(url !== origUrl){origUrl = url; nextPage = 2; hasMorePages = true;}\n                        let noMoreLazyLoadContent = document.getElementsByTagName('no-more-lazyload-content');\n                        if(noMoreLazyLoadContent.length > 0){\n                            for(let i = 0; i < noMoreLazyLoadContent.length; i++){noMoreLazyLoadContent[i].remove();}\n                            hasMorePages = false;\n                            return;\n                        }\n                        let loadingElm = document.createElement('p');\n                        loadingElm.classList.add('lazyload-loading');\n                        loadingElm.innerText = 'Loading...';\n                        if(elm === jQuery(window)){\n                            jQuery('body').append(loadingElm);\n                        }else{elm.append(loadingElm);}\n                        let thisNonceKey = document.getElementById('lazy-load-page-script').getAttribute('nonce') || false;\n                        if(!thisNonceKey || thisNonceKey.toString().trim() === ''){thisNonceKey = false;}\n                        jQuery.ajax({\n                            url: url,\n                            method: '${e.method}',\n                            dataType: 'html',\n                            data: {lazyLoadData: '{"page": '+(nextPage++)+', "contentOnly": true, "key": "${g}", "nonce": "'+thisNonceKey+'", "tag": "${e.origTag}", "scrollElm": "${e.origScrollElm}", "method": "${e.origMethod}", "afterVars": "${e.afterVars}"}'},\n                            timeout: 15000,\n                            success: function(data){\n                                loadingElm.remove();\n                                if(!data || data.toString().trim() === ''){\n                                    hasMorePages = false;\n                                }else{\n                                    data = data.toString();\n                                    if(data.includes('<no-more-lazyload-content></no-more-lazyload-content>')){\n                                        hasMorePages = false;\n                                        data = data.replace(/<no-more-lazyload-content><\\/no-more-lazyload-content>/g, '');\n                                    }\n                                    if(elm === window){\n                                        jQuery('body').append(data);\n                                    }else{elm.append(data.toString());}\n                                    document.dispatchEvent(onPageLazyLoad);\n                                }\n                                gettingPage = false;\n                                if(hasMorePages && !gettingPage){getNextPage(elm, scrollElm);}\n                            },\n                            error: function(xhr){\n                                console.log(xhr.status);\n                                loadingElm.classList.add('lazyload-loading-error');\n                                loadingElm.innerHTML = 'Failed To Load!';\n                                hasMorePages = false;\n                                gettingPage = false;\n                            }\n                        });\n                    }\n                }\n                getNextPage(jQuery(${e.tag}), jQuery(${e.scrollElm||e.tag}));\n                jQuery(${e.scrollElm||e.tag}).on('scroll', function(){\n                    if(hasMorePages && !gettingPage){\n                        getNextPage(jQuery(${e.tag}), jQuery(${e.scrollElm||e.tag}));\n                    }else if(!gettingPage){\n                        let url = window.location.pathname.toLowerCase().replace(/([^w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                        if(${!e.unsafeUrl||!0}){url = url.replace(/[^w_\\-+/]/g, '-');}\n                        if(url !== origUrl){origUrl = url; nextPage = 2; hasMorePages = true;}\n                    }\n                });\n            });\n        }\n        \n        function loadPageXml(){\n            document.addEventListener('DOMContentLoaded', function(){\n                const body = document.body || document.getElementsByTagName('body')[0];\n                function getNextPage(elm, scrollElm){\n                    let totalScrollHeight = (scrollElm.scrollHeight || body.scrollHeight) - (scrollElm.innerHeight || scrollElm.clientHeight);\n                    let currentScrollHeight = scrollElm.scrollTop || window.scrollY;\n                    if(!gettingPage && totalScrollHeight - currentScrollHeight < 200){\n                        gettingPage = true;\n                        let url = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                        if(${!e.unsafeUrl||!0}){url = url.replace(/[^\\w_\\-+/]/g, '-');}\n                        if(url !== origUrl){origUrl = url; nextPage = 2; hasMorePages = true;}\n                        let noMoreLazyLoadContent = document.getElementsByTagName('no-more-lazyload-content');\n                        if(noMoreLazyLoadContent.length > 0){\n                            for(let i = 0; i < noMoreLazyLoadContent.length; i++){noMoreLazyLoadContent[i].remove();}\n                            hasMorePages = false;\n                            return;\n                        }\n                        let loadingElm = document.createElement('p');\n                        loadingElm.classList.add('lazyload-loading');\n                        loadingElm.innerText = 'Loading...';\n                        if(elm === window){\n                            body.appendChild(loadingElm);\n                        }else{elm.appendChild(loadingElm);}\n                        let thisNonceKey = document.getElementById('lazy-load-page-script').getAttribute('nonce') || false;\n                        if(!thisNonceKey || thisNonceKey.toString().trim() === ''){thisNonceKey = false;}\n                        const xhr = new XMLHttpRequest();\n                        xhr.onreadystatechange = function(){\n                            if(xhr.readyState == XMLHttpRequest.DONE){\n                                if(xhr.status == 200){\n                                    let data = xhr.responseText;\n                                    loadingElm.remove();\n                                    if(!data || data.toString().trim() === ''){\n                                        hasMorePages = false;\n                                    }else{\n                                        data = data.toString();\n                                        if(data.includes('<no-more-lazyload-content></no-more-lazyload-content>')){\n                                            hasMorePages = false;\n                                            data = data.replace(/<no-more-lazyload-content><\\/no-more-lazyload-content>/g, '');\n                                        }\n                                        let newElm = document.createElement('div');\n                                        newElm.innerHTML = data;\n                                        if(elm === window){\n                                            body.appendChild(newElm);\n                                        }else{elm.appendChild(newElm);}\n                                        document.dispatchEvent(onPageLazyLoad);\n                                    }\n                                    gettingPage = false;\n                                    totalScrollHeight = (scrollElm.scrollHeight || body.scrollHeight) - (scrollElm.innerHeight || scrollElm.clientHeight);\n                                    currentScrollHeight = scrollElm.scrollTop || window.scrollY;\n                                    if(hasMorePages && !gettingPage){getNextPage(elm, scrollElm);}\n                                }else{\n                                    if(xhr.status == 404){\n                                        loadingElm.remove();\n                                    }else{\n                                        loadingElm.classList.add('lazyload-loading-error');\n                                        loadingElm.innerHTML = 'Failed To Load!';\n                                    }\n                                    hasMorePages = false;\n                                    gettingPage = false;\n                                }\n                            }\n                        };\n                        if('${e.method}' === 'GET'){\n                            xhr.open('GET', url+'?lazyLoadData={"page": '+(nextPage++)+', "contentOnly": true, "key": "${g}", "nonce": "'+thisNonceKey+'", "tag": "${e.origTag}", "scrollElm": "${e.origScrollElm}", "method": "${e.origMethod}", "afterVars": "${e.afterVars}"}', true);\n                            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n                            xhr.send();\n                        }else{\n                            xhr.open('POST', url, true);\n                            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n                            xhr.send('lazyLoadData={"page": '+(nextPage++)+', "contentOnly": true, "key": "${g}", "nonce": "'+thisNonceKey+'", "tag": "${e.origTag}", "scrollElm": "${e.origScrollElm}", "method": "${e.origMethod}", "afterVars": "${e.afterVars}"}');\n                        }\n                    }\n                }\n                if(${e.scrollElm||e.tag} === window){\n                    getNextPage(document.getElementsByTagName(${e.tag})[0], window);\n                    document.addEventListener('scroll', function(){\n                        if(hasMorePages && !gettingPage){\n                            getNextPage(document.getElementsByTagName(${e.tag})[0], window);\n                        }else if(!gettingPage){\n                            let url = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                            if(${!e.unsafeUrl||!0}){url = url.replace(/[^\\w_\\-+/]/g, '-');}\n                            if(url !== origUrl){origUrl = url; nextPage = 2; hasMorePages = true;}\n                        }\n                    });\n                }else{\n                    let scrollElm = false;\n                    let scrollElmTag = ${e.scrollElm||e.tag};\n                    if(scrollElmTag.startsWith('#')){scrollElm = document.getElementById(scrollElmTag.replace('#', ''));}\n                    else if(scrollElmTag.startsWith('.')){scrollElm = document.getElementsByClassName(scrollElmTag.replace('.', ''))[0];}\n                    else{scrollElm = document.getElementsByTagName(scrollElmTag)[0];}\n                    getNextPage(document.getElementsByTagName(${e.tag})[0], scrollElm);\n                    scrollElm.addEventListener('scroll', function(){\n                        if(hasMorePages && !gettingPage){\n                            getNextPage(document.getElementsByTagName(${e.tag})[0], scrollElm);\n                        }else if(!gettingPage){\n                            let url = window.location.pathname.toLowerCase().replace(/([^\\w_-])?:(\\/\\/|\\\\\\\\)/gs, '').replace(/(:|\\/\\/:\\\\\\\\)/gs, '').replace(/\\\\/gs, '/');\n                            if(${!e.unsafeUrl||!0}){url = url.replace(/[^\\w_\\-+/]/g, '-');}\n                            if(url !== origUrl){origUrl = url; nextPage = 2; hasMorePages = true;}\n                        }\n                    });\n                }\n            });\n        }\n        setTimeout(function(){\n            if(typeof $ === 'function' || typeof $ === 'object'){\n                loadPageAjax($);\n            }else if(typeof jQuery === 'function' || typeof jQuery === 'object'){\n                loadPageAjax(jQuery);\n            }else if(typeof jquery === 'function' || typeof jquery === 'object'){\n                loadPageAjax(jquery);\n            }else{\n                loadPageXml();\n            }\n        }, 100);\n    })();\n    <\/script>\n    `}function P(e){return e||0===e||!1===e?e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.toString()).replace(/\*\*\*([^*]+)\*\*\*/g,"<strong><em>$1</em></strong>")).replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/\*([^*]+)\*/g,"<em>$1</em>")).replace(/&ast;&ast;&ast;((?!&ast;).+)&ast;&ast;&ast;/g,"<strong><em>$1</em></strong>")).replace(/&ast;&ast;((?!&ast;).+)&ast;&ast;/g,"<strong>$1</strong>")).replace(/&ast;((?!&ast;).+)&ast;/g,"<em>$1</em>")).replace(/__([^_]+)__/g,"<u>$1</u>")).replace(/~~([^~]+)~~/gs,"<s>$1</s>")).replace(/######(.+)/g,"<h6>$1</h6>")).replace(/#####(.+)/g,"<h5>$1</h5>")).replace(/####(.+)/g,"<h4>$1</h4>")).replace(/###(.+)/g,"<h3>$1</h3>")).replace(/##(.+)/g,"<h2>$1</h2>")).replace(/#(.+)/g,"<h1>$1</h1>")).replace(/[\n\r]--([-]+)[\n\r]/g,"<hr>")).replace(/(?:```(.+?)```|&grave;&grave;&grave;(.*?)&grave;&grave;&grave;)/gs,"<pre>$1</pre>")).replace(/(?:`(.+?)`|&grave;(.*?)&grave;)/gs,"<p>$1</p>")).replace(/([^"'])((?!["'])https?:\/\/(?:(?:[\w_-][\w_\-.]+)|)(?:(?:[\w.,@?^=%&:/~+#_-]*[\w.,@?^=%&:/~+#_-])|))/g,'$1<a href="$2">$2</a>'):null}function v(e){if(!e&&0!==e&&!1!==e)return null;if(e=x(e),!r||r.length<1)return e.toString();const t=r.join("|");let n=[],a=new RegExp("(</?(?![^A-Za-z0-9_-]|!DOCTYPE|"+t+")(?:(?:\\s+?[^>]*?)|)>)","gsi");if(!l(a))return e.toString();for(e=e.split(a).map(e=>{if(e.match(a)){let t=e.replace(/<\/?([A-Za-z0-9_-]+).*?>/gis,"$1");if(e.startsWith("</")){if(n.length<=0)return"";if(n[n.length-1]===t)return n.pop(),"</"+t+">";{let e="";for(;n.length>0&&n[n.length-1]!==t;)e+="</"+n[n.length-1]+">",n.pop();return e}}n.push(t)}return e});n.length>0;)e.push("</"+n[n.length-1]+">"),n.pop();return(e=e.join("")).toString()}function x(e){return e||0===e||!1===e?e.toString().replace(/<\/?([A-Za-z0-9_-]+)([^>]+)(<|.$)/gis,"&lt;$1$2$3"):null}function _(e){return e||0===e||!1===e?e.toString().replace(/<\/?([A-Za-z0-9_-]+)([^>]+)(<|.$)/gis,"$2$3"):null}function A(e){return e||0===e||!1===e?e.toString().replace(/&(?!(amp|gt|lt|sol|bsol|lbrace|rbrace);)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/{/g,"&lbrace;").replace(/}/g,"&rbrace;"):null}function H(e){return e||0===e||!1===e?e.toString().replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&lbrace;/g,"{").replace(/&rbrace;/g,"}"):null}function N(e,t){if("string"==typeof e&&(e=[e]),e&&"object"==typeof e){let n=Object.keys(e);for(let l=0;l<n.length;l++)t(e[n[l]],n[l],e)}else if(e&&Array.isArray(e))for(let n=0;n<e.length;n++)t(e[n],n,e)}function j(e,t){if(!e||!t||"object"!=typeof e&&!Array.isArray(e)||"string"!=typeof t&&"number"!=typeof t&&"boolean"!=typeof t)return null;t=t.toString().split("|");for(let l=0;l<t.length;l++){if(t[l]=t[l].trim(),t[l].match(/^(["'])(.*?)(\1)/))return t[l].replace(/^(["'])(.*?)(\1)/,"$2");function n(e,t){if(t&&"object"==typeof e&&"undefined"!=typeof e[t])return e[t]}t[l]=t[l].split(/(?:\.|:|\[([^\]]+)\])/gs).filter(e=>e&&""!==e.trim());let a=void 0;if(t[l][0].startsWith("$")&&"object"==typeof e.$?(t[l][0]=t[l][0].replace("$",""),a=t[l].reduce(n,e.$)):t[l][0].startsWith("$")||(a=t[l].reduce(n,e)),a)return a}}module.exports=(()=>{let e=function(e=!1){return"object"==typeof e&&(Object.assign(s,e),(e.cacheDev||!1===e.cacheDev)&&a.cacheDevelopment(e.cacheDev)),h};return e.render=L,e.addFunction=m,e.defineSingleTagType=f,e.basicMarkdown=P,e.escapeHtml=A,e.unescapeHtml=H,e.escapeInvalidTags=x,e.stripInvalidTags=_,e})();